//swiftc -O -framework SwiftUI -framework AppKit Gemini.swift -o Gemini
import SwiftUI
import AppKit
import Observation

// MARK: - 1. 模型层
@Observable
class ChatViewModel {
    var chatHistory: [ChatMessage] = []
    var isSending = false
    var apiKey: String = ""
    var isLowPowerMode: Bool = ProcessInfo.processInfo.isLowPowerModeEnabled
    
    init() {
        NotificationCenter.default.addObserver(
            forName: NSNotification.Name.NSProcessInfoPowerStateDidChange,
            object: nil,
            queue: .main
        ) { [weak self] _ in
            self?.isLowPowerMode = ProcessInfo.processInfo.isLowPowerModeEnabled
        }
    }

    func loadHistory() {
        let path = "/tmp/gemini_history_swift.json"
        guard let data = try? Data(contentsOf: URL(fileURLWithPath: path)),
              let decoded = try? JSONDecoder().decode([ChatMessage].self, from: data) else { return }
        self.chatHistory = decoded
    }
    
    func saveHistory() {
        let path = "/tmp/gemini_history_swift.json"
        if let data = try? JSONEncoder().encode(chatHistory) {
            try? data.write(to: URL(fileURLWithPath: path))
        }
    }
    
    func sendToGemini(text: String) async {
        guard !text.isEmpty else { return }
        await MainActor.run {
            chatHistory.append(ChatMessage(role: "user", parts: [ChatPart(text: text)]))
            isSending = true
        }
        
        // 注意：此处模型名称可能随时间变化，确保使用有效的 Gemini 模型名称
        let endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=\(apiKey)"
        guard let url = URL(string: endpoint) else { return }
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.httpBody = try? JSONEncoder().encode(["contents": chatHistory])
        
        do {
            let (data, _) = try await URLSession.shared.data(for: request)
            if let response = try? JSONDecoder().decode(GeminiResponse.self, from: data),
               let modelText = response.candidates.first?.content.parts.first?.text {
                await MainActor.run {
                    chatHistory.append(ChatMessage(role: "model", parts: [ChatPart(text: modelText)]))
                    saveHistory()
                }
            } else {
                // 简单的错误打印，方便调试
                if let jsonStr = String(data: data, encoding: .utf8) { print("Error Response: \(jsonStr)") }
            }
        } catch { print(error) }
        await MainActor.run { isSending = false }
    }
}

struct ChatMessage: Codable, Identifiable {
    var id = UUID(); let role: String; let parts: [ChatPart]
    enum CodingKeys: String, CodingKey { case role, parts }
}
struct ChatPart: Codable { let text: String }
struct GeminiResponse: Codable {
    struct Candidate: Codable {
        struct Content: Codable { let parts: [ChatPart] }; let content: Content
    }
    let candidates: [Candidate]
}

// MARK: - 2. UI 层
struct ContentView: View {
    @Bindable var viewModel: ChatViewModel
    @State private var inputText = ""
    let paperColor = Color(red: 0.98, green: 0.976, blue: 0.965)

    var body: some View {
        VStack(spacing: 0) {
            ScrollViewReader { proxy in
                ScrollView {
                    LazyVStack(alignment: .leading, spacing: 24) {
                        ForEach(viewModel.chatHistory) { msg in
                            VStack(alignment: .leading, spacing: 8) {
                                Text(msg.role == "user" ? "You" : "Gemini")
                                    .font(.system(size: 13, weight: .bold))
                                    .foregroundColor(.secondary)
                                
                                // 核心修改：确保这里允许文本选择
                                Text(msg.parts.first?.text ?? "")
                                    .font(.system(size: 16))
                                    .lineSpacing(6)
                                    .foregroundColor(msg.role == "user" ? .primary : Color(red: 0.12, green: 0.28, blue: 0.45))
                                    .textSelection(.enabled) // 允许鼠标拖拽选择
                            }
                            .id(msg.id)
                        }
                    }
                    .padding(30)
                }
                .onChange(of: viewModel.chatHistory.count) {
                    proxy.scrollTo(viewModel.chatHistory.last?.id)
                }
            }
            
            HStack(spacing: 12) {
                // 这里的输入框现在支持 Command+V 了，因为我们添加了 Edit 菜单
                TextField("Ask Gemini...", text: $inputText)
                    .textFieldStyle(.roundedBorder)
                    .onSubmit { sendMessage() }
                    .disabled(viewModel.isSending)
                
                Button(action: sendMessage) {
                    if viewModel.isSending { ProgressView().controlSize(.small) } else { Text("Send") }
                }
                .buttonStyle(.borderedProminent)
            }
            .padding()
            .background {
                if viewModel.isLowPowerMode { paperColor } else { Rectangle().fill(.ultraThinMaterial) }
            }
        }
        .background(paperColor)
    }
    
    func sendMessage() {
        let text = inputText; guard !text.isEmpty else { return }; inputText = ""
        Task { await viewModel.sendToGemini(text: text) }
    }
}

// MARK: - 3. 应用入口
class AppDelegate: NSObject, NSApplicationDelegate {
    var window: NSWindow!
    var viewModel = ChatViewModel()

    func applicationDidFinishLaunching(_ notification: Notification) {
        // 1. 设置主菜单（修复复制/粘贴的关键步骤）
        setupMenu()
        
        if CommandLine.arguments.count > 1 { viewModel.apiKey = CommandLine.arguments[1] }
        viewModel.loadHistory()

        window = NSWindow(
            contentRect: NSRect(x: 0, y: 0, width: 800, height: 600),
            styleMask: [.titled, .closable, .miniaturizable, .resizable, .fullSizeContentView],
            backing: .buffered, defer: false)
        window.center()
        window.title = "Gemini Reader"
        window.titlebarAppearsTransparent = true
        window.contentView = NSHostingView(rootView: ContentView(viewModel: viewModel))
        window.makeKeyAndOrderFront(nil)
        
        NSApp.activate(ignoringOtherApps: true)
    }
    
    // 手动创建 macOS 菜单栏
    func setupMenu() {
        let mainMenu = NSMenu()
        
        // App 菜单 (Application Name)
        let appMenuItem = NSMenuItem()
        mainMenu.addItem(appMenuItem)
        let appMenu = NSMenu()
        appMenuItem.submenu = appMenu
        appMenu.addItem(withTitle: "Quit", action: #selector(NSApplication.terminate(_:)), keyEquivalent: "q")
        
        // Edit 菜单 (这是让 Cmd+C / Cmd+V / Cmd+A 生效的关键)
        let editMenuItem = NSMenuItem()
        mainMenu.addItem(editMenuItem)
        let editMenu = NSMenu(title: "Edit")
        editMenuItem.submenu = editMenu
        
        editMenu.addItem(withTitle: "Cut", action: #selector(NSText.cut(_:)), keyEquivalent: "x")
        editMenu.addItem(withTitle: "Copy", action: #selector(NSText.copy(_:)), keyEquivalent: "c")
        editMenu.addItem(withTitle: "Paste", action: #selector(NSText.paste(_:)), keyEquivalent: "v")
        editMenu.addItem(withTitle: "Select All", action: #selector(NSText.selectAll(_:)), keyEquivalent: "a")
        
        // Window 菜单 (可选，用于全屏等操作)
        let windowMenuItem = NSMenuItem()
        mainMenu.addItem(windowMenuItem)
        let windowMenu = NSMenu(title: "Window")
        windowMenuItem.submenu = windowMenu
        windowMenu.addItem(withTitle: "Minimize", action: #selector(NSWindow.performMiniaturize(_:)), keyEquivalent: "m")
        windowMenu.addItem(withTitle: "Zoom", action: #selector(NSWindow.performZoom(_:)), keyEquivalent: "")
        
        NSApp.mainMenu = mainMenu
    }
    
    func applicationShouldTerminateAfterLastWindowClosed(_ sender: NSApplication) -> Bool { return true }
}

let app = NSApplication.shared
let delegate = AppDelegate()
app.delegate = delegate
app.setActivationPolicy(.regular)
app.run()
